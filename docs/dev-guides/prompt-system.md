# プロンプトシステムアーキテクチャ

`tech-articles-prompt/` ディレクトリ内のプロンプトファイルが本フレームワークのコアです。

## マクロ構文システム

プロンプトファイルの形式的定義には、統一されたマクロ構文を使用します。詳細は以下を参照:

- `tech-articles-prompt/macro-syntax.md` - マクロ構文の形式定義、BNF仕様、共通マクロ定義

**マクロ構文の基本形式:**

```COBOL
DEF <定義対象> THEN
  <実行内容>
END
```

**主要なマクロ種別:**

| マクロ種別   | 例                                                       |
| ------------ | -------------------------------------------------------- |
| モード定義   | `DEF MODE コマンド, 入力, 待機 THEN ...`                 |
| コマンド定義 | `DEF /begin THEN CLEAR :buffer; SET MODE = 入力 END`     |
| 変数定義     | `DEF VAR SESSION :role THEN CLEARBY /exit END`           |
| 優先度定義   | `DEF PRIORITY S, A, B, C, E THEN ...`                    |
| 出力形式定義 | `DEF OUTPUT レビュー結果 THEN FIELD セクション: ... END` |

## 変数システム

**変数スコープ:**

| スコープ  | ライフサイクル                        | クリアタイミング |
| --------- | ------------------------------------- | ---------------- |
| `SESSION` | セッション全体で保持                  | `/exit` 実行時   |
| `REVIEW`  | レビューサイクル（入力→処理）内で保持 | `/begin` 実行時  |

**共通変数:**

- `:buffer` - 記事内容を保持（REVIEW スコープ）
- `:review` - レビュー結果を保持（REVIEW スコープ）
- `:role` - AI エージェントの役割（SESSION スコープ）
- `:link` - 参考リンク（SESSION スコープ）
- `:remark` - 特記事項（SESSION スコープ）

## コマンド構文

**共通コマンド:**（全プロンプトファイルで使用可能）

| コマンド                       | 説明                               |
| ------------------------------ | ---------------------------------- |
| `/begin`                       | 入力モード開始（`:buffer` クリア） |
| `/end`                         | 待機モード移行（入力完了）         |
| `/reset <:変数1> [<:変数2>..]` | 指定変数のクリア                   |
| `/set <:変数> = <値>`          | 変数に値を設定                     |
| `/exit`                        | モード終了、メモリリセット         |

**プロンプト固有コマンド:**

| プロンプトファイル            | 固有コマンド                                           |
| ----------------------------- | ------------------------------------------------------ |
| `article-review.prompt`       | `/review`, `/show`, `/quickfix`, `/appendix`, `/chart` |
| `article-proofreading.prompt` | `/review`                                              |
| `article-writer.prompt`       | `/write`                                               |

**注記**:

- 待機 MODE では自動処理を行わず、すべての処理は明示的なコマンドによってのみ実行されます
- `/review` コマンドは MODE=待機のままレビュー/校閲処理を実行します
- `/write` コマンドは MODE=待機のまま記事作成処理を実行します

## パース構文

- `#` - セクション開始
- `:variable` - 変数定義
- `""""` - 入力区切り
- `;` - コメント（処理前に削除）

## モード遷移

すべてのプロンプトファイルがもつ、共通のモード遷移構造:

```bash
[初期状態]
    ↓
┌──────────────┐
│コマンドモード│ ←──────────┐
└──────────────┘            │
    ↓ /begin                │
┌─────────────┐             │
│ 入力モード  │             │
└─────────────┘             │
    ↓ /end                  │
┌─────────────┐             │
│ 待機モード  │             │
│             │             │
│ /review ────┼─→ 処理実行  │
│ /write  ────┼─→ 処理実行  │
└─────────────┘             │
    ↓ /exit                 │
    └───────────────────────┘
```

**注記**:

- 待機 MODE では自動処理を行わず、明示的なコマンドによってのみ処理を実行します
- 待機 MODE のまま `/review`, `/write` などのコマンドで処理を実行します
- MODE 遷移を伴わないため、処理後も待機 MODE に留まります
- 入力を修正したい場合は `/begin` で入力モードに戻れます
- 各プロンプトファイルの処理開始コマンド:
  - `article-review.prompt`: `/review` (MODE=待機のまま実行)
  - `article-proofreading.prompt`: `/review` (MODE=待機のまま実行)
  - `article-writer.prompt`: `/write` (MODE=待機のまま実行)
